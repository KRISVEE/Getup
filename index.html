<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Unscripted Engine</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;700&display=swap');

        :root {
            --accent-color: #ff8a00;
            --bg-dark: #050505;
            --glass-bg: rgba(15, 15, 25, 0.7);
        }

        /* Fixes responsiveness for inputs */
        * { box-sizing: border-box; } 

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-dark);
            color: #ffffff;
            font-family: 'Space Grotesk', sans-serif;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; width: 100vw;
            overflow: hidden; touch-action: none;
        }

        .glass-panel {
            position: absolute;
            width: 90%; max-width: 360px;
            padding: 30px 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
            z-index: 20;
            display: none; 
            flex-direction: column; gap: 15px;
            max-height: 95vh; overflow-y: auto;
        }

        .active-panel { display: flex; }

        h1, h2 { margin: 0; }
        .title {
            font-size: 1.5rem; font-weight: 700;
            color: var(--accent-color);
            text-shadow: 0 0 10px var(--accent-color);
            margin-bottom: 5px;
        }

        input[type="text"], input[type="color"] {
            width: 100%; padding: 12px;
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px; color: #fff;
            font-family: 'Space Grotesk', sans-serif;
            outline: none; transition: 0.3s;
        }
        input[type="text"]:focus { border-color: var(--accent-color); }

        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 8px;
            background: var(--accent-color); color: #fff;
            font-weight: 700; font-family: 'Space Grotesk', sans-serif;
            cursor: pointer; font-size: 1rem;
            box-shadow: 0 0 15px var(--accent-color);
            transition: transform 0.1s, filter 0.3s;
        }
        .btn:active { transform: scale(0.95); }

        /* Outline button for secondary actions (Main Menu) */
        .btn-outline {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: none;
        }

        .toggle-container {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            font-size: 0.9rem; color: #a0a0a0; margin: 5px 0;
        }

        #creator-options { display: none; flex-direction: column; gap: 10px; }

        #hud {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 5; display: none;
        }
        #score-display {
            position: absolute; top: 8%; width: 100%; text-align: center;
            font-size: 3rem; font-weight: 700; color: rgba(255,255,255,0.8);
        }
        #story-display {
            position: absolute; top: 20%; width: 100%; text-align: center;
            font-size: 1rem; color: rgba(255,255,255,0.6); transition: opacity 0.5s;
        }

        canvas { width: 100vw; height: 100vh; display: block; }
        
        #share-preview {
            width: 100%; border-radius: 10px; margin-bottom: 5px;
            border: 1px solid rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>

    <div id="setup-panel" class="glass-panel active-panel">
        <div class="title">Define Your Journey</div>
        <input type="text" id="input-name" placeholder="Your Name (Optional)">
        <input type="text" id="input-pressure" placeholder="Escaping what? (e.g. Society, Exams, Fear)">
        <input type="text" id="input-dream" placeholder="What is your goal? (e.g. Startup, Peace)">
        
        <div class="toggle-container">
            <input type="checkbox" id="creator-toggle">
            <label for="creator-toggle">Enable Creator Mode</label>
        </div>

        <div id="creator-options">
            <input type="text" id="input-handle" placeholder="IG Handle (e.g. @prithvi.dll)">
            <div style="display:flex; justify-content: space-between; align-items:center;">
                <label style="font-size:0.8rem;">Brand Color:</label>
                <input type="color" id="input-color" value="#ff8a00" style="width: 50px; padding:0; height: 35px;">
            </div>
        </div>

        <button class="btn" id="btn-start">Ignite</button>
    </div>

    <div id="game-over-panel" class="glass-panel">
        <div class="title" style="color: #ff4757; text-shadow: 0 0 10px #ff4757;">The Script Caught You</div>
        <img id="share-preview" src="" alt="Share to IG">
        <button class="btn" id="btn-download" style="background: #ffffff; color: #000; box-shadow: none;">Download Story Format</button>
        <button class="btn" id="btn-restart">Try Again</button>
        <button class="btn btn-outline" id="btn-menu">Main Menu</button>
    </div>

    <div id="hud">
        <div id="score-display">0</div>
        <div id="story-display"></div>
    </div>
    <canvas id="gameCanvas"></canvas>

<script>
    const Config = {
        name: "Traveler",
        pressures: ["The Script"], // Now an array!
        dream: "Freedom",
        isCreator: false,
        handle: "",
        color: "#ff8a00"
    };

    const AudioSys = {
        ctx: null,
        init() {
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            this.ctx = new AudioContext();
        },
        playJump() {
            if(!this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.connect(gain); gain.connect(this.ctx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(300, this.ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(500, this.ctx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.1);
            osc.start(); osc.stop(this.ctx.currentTime + 0.1);
        },
        playCrash() {
            if(!this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.connect(gain); gain.connect(this.ctx.destination);
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, this.ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(10, this.ctx.currentTime + 0.3);
            gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.3);
            osc.start(); osc.stop(this.ctx.currentTime + 0.3);
        }
    };

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    
    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    const Engine = {
        active: false, frames: 0, score: 0, difficultyMult: 1,
        shakeTime: 0, nextSpawnDistance: 0,
        particles: [], stars: [], obstacles: [],
        
        player: {
            x: window.innerWidth * 0.2, y: window.innerHeight / 2, radius: 10,
            vel: 0, grav: 0.35, jump: -6.5,
            update() {
                this.vel += this.grav; this.y += this.vel;
                Engine.particles.push({ x: this.x, y: this.y, life: 1, size: Math.random()*3+2 });
                if(this.y + this.radius > canvas.height || this.y < 0) Engine.crash();
            },
            draw() {
                let glow = 15 + Math.sin(Engine.frames * 0.1) * 5;
                ctx.shadowBlur = glow; ctx.shadowColor = Config.color;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2);
                ctx.fillStyle = "#fff"; ctx.fill(); ctx.shadowBlur = 0;
            },
            flap() { this.vel = this.jump; AudioSys.playJump(); }
        },

        initStars() {
            this.stars = [];
            for(let i=0; i<60; i++) this.stars.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, size: Math.random()*2, speed: Math.random()*0.5 + 0.2 });
        },

        spawnObstacle() {
            const gap = Math.max(140, 220 - (this.score * 2.5)); 
            const topH = Math.random() * (canvas.height / 2.5) + 50;
            const w = window.innerWidth > 600 ? 60 : 45;
            
            // Pick a random word from the multiple pressures provided
            const randomWord = Config.pressures[Math.floor(Math.random() * Config.pressures.length)];

            this.obstacles.push({
                x: canvas.width, w: w, topH: topH, bottomY: topH + gap, passed: false,
                word: randomWord.toUpperCase()
            });
        },

        loop() {
            if(!Engine.active) return;
            
            ctx.save();
            if(Engine.shakeTime > 0) {
                const dx = (Math.random()-0.5)*10; const dy = (Math.random()-0.5)*10;
                ctx.translate(dx, dy); Engine.shakeTime--;
            }

            let bgGrad = ctx.createLinearGradient(0,0,0,canvas.height);
            bgGrad.addColorStop(0, "#0a0a1a"); bgGrad.addColorStop(1, "#1a1a2e");
            ctx.fillStyle = bgGrad; ctx.fillRect(0,0,canvas.width,canvas.height);

            ctx.fillStyle = "#fff";
            Engine.stars.forEach(s => {
                s.x -= s.speed * Engine.difficultyMult;
                if(s.x < 0) s.x = canvas.width;
                ctx.globalAlpha = 0.5; ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI*2); ctx.fill();
            });
            ctx.globalAlpha = 1;

            Engine.particles.forEach((p, i) => {
                p.x -= 2 * Engine.difficultyMult; p.life -= 0.05;
                ctx.fillStyle = `rgba(${Config.color === '#ff8a00' ? '255,138,0' : '255,255,255'}, ${p.life})`;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
                if(p.life <= 0) Engine.particles.splice(i, 1);
            });

            Engine.player.update();
            Engine.player.draw();

            // FIX: DISTANCE-BASED SPAWNING (Fixes 120Hz overlapping bug)
            let lastObs = Engine.obstacles[Engine.obstacles.length - 1];
            if (!lastObs || (canvas.width - lastObs.x) > Engine.nextSpawnDistance) {
                Engine.spawnObstacle();
                // Randomize distance between pillars so it feels organic, but guarantee a safe minimum gap
                Engine.nextSpawnDistance = Math.max(180, 260 - Engine.score * 2) + Math.random() * 80;
            }

            Engine.obstacles.forEach((obs, i) => {
                obs.x -= 3.5 * Engine.difficultyMult;
                
                let grad = ctx.createLinearGradient(obs.x, 0, obs.x+obs.w, 0);
                grad.addColorStop(0, "#111"); grad.addColorStop(0.5, "#222"); grad.addColorStop(1, "#111");
                ctx.fillStyle = grad;
                ctx.fillRect(obs.x, 0, obs.w, obs.topH);
                ctx.fillRect(obs.x, obs.bottomY, obs.w, canvas.height - obs.bottomY);

                ctx.shadowBlur = 10; ctx.shadowColor = "#ff0055"; ctx.fillStyle = "#ff4757";
                ctx.font = "bold 14px 'Space Grotesk'";
                ctx.fillText(obs.word, obs.x - 10, obs.topH - 20); 
                ctx.shadowBlur = 0;

                if (Engine.player.x + Engine.player.radius > obs.x && 
                    Engine.player.x - Engine.player.radius < obs.x + obs.w &&
                    (Engine.player.y - Engine.player.radius < obs.topH || Engine.player.y + Engine.player.radius > obs.bottomY)) {
                    Engine.crash();
                }

                if (obs.x + obs.w < Engine.player.x - Engine.player.radius && !obs.passed) {
                    Engine.score++; document.getElementById('score-display').innerText = Engine.score;
                    obs.passed = true;
                    Engine.difficultyMult += 0.015; 
                    
                    for(let j=0; j<10; j++) Engine.particles.push({x: Engine.player.x, y: Engine.player.y, life: 1, size: Math.random()*5+2});
                    UI.updateStory();
                }

                if (obs.x + obs.w < -100) Engine.obstacles.splice(i, 1);
            });

            ctx.restore();
            Engine.frames++;
            requestAnimationFrame(Engine.loop);
        },

        crash() {
            Engine.active = false;
            Engine.shakeTime = 15;
            AudioSys.playCrash();
            
            ctx.save();
            const dx = (Math.random()-0.5)*20; const dy = (Math.random()-0.5)*20;
            ctx.translate(dx, dy);
            ctx.fillStyle = "rgba(255,0,0,0.3)"; ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.restore();

            setTimeout(() => UI.showGameOver(), 500);
        },

        start() {
            this.active = true; this.score = 0; this.frames = 0; this.difficultyMult = 1;
            this.obstacles = []; this.particles = []; this.nextSpawnDistance = 0;
            this.player.y = canvas.height / 2; this.player.vel = 0;
            document.getElementById('score-display').innerText = 0;
            this.initStars();
            UI.updateStory(true);
            AudioSys.init();
            this.loop();
        }
    };

    const UI = {
        setupPanel: document.getElementById('setup-panel'),
        gameOverPanel: document.getElementById('game-over-panel'),
        hud: document.getElementById('hud'),
        storyDisplay: document.getElementById('story-display'),

        init() {
            document.getElementById('creator-toggle').addEventListener('change', (e) => {
                document.getElementById('creator-options').style.display = e.target.checked ? 'flex' : 'none';
            });

            document.getElementById('btn-start').addEventListener('click', () => {
                Config.name = document.getElementById('input-name').value || "Traveler";
                
                // Parse comma-separated words into an array
                const rawPressure = document.getElementById('input-pressure').value;
                if(rawPressure.trim() !== "") {
                    Config.pressures = rawPressure.split(',').map(s => s.trim()).filter(s => s !== "");
                } else {
                    Config.pressures = ["The Script"];
                }

                Config.dream = document.getElementById('input-dream').value || "Freedom";
                Config.isCreator = document.getElementById('creator-toggle').checked;
                if(Config.isCreator) {
                    Config.handle = document.getElementById('input-handle').value;
                    Config.color = document.getElementById('input-color').value;
                    document.documentElement.style.setProperty('--accent-color', Config.color);
                }

                this.setupPanel.classList.remove('active-panel');
                this.hud.style.display = 'block';
                Engine.start();
            });

            window.addEventListener('touchstart', (e) => { if(Engine.active) { e.preventDefault(); Engine.player.flap(); } }, {passive: false});
            window.addEventListener('mousedown', () => { if(Engine.active) Engine.player.flap(); });

            document.getElementById('btn-restart').addEventListener('click', () => {
                this.gameOverPanel.classList.remove('active-panel');
                this.hud.style.display = 'block';
                Engine.start();
            });

            // ADDED: Main Menu Button Logic
            document.getElementById('btn-menu').addEventListener('click', () => {
                this.gameOverPanel.classList.remove('active-panel');
                this.setupPanel.classList.add('active-panel');
                ctx.clearRect(0,0,canvas.width,canvas.height); // clear screen
            });

            document.getElementById('btn-download').addEventListener('click', () => {
                const link = document.createElement('a');
                link.download = 'unscripted-journey.png';
                link.href = document.getElementById('share-preview').src;
                link.click();
            });
        },

        updateStory(reset = false) {
            const displayPressure = Config.pressures[0]; // Just use the first one for the background text
            const stories = [
                `Escaping ${displayPressure}...`,
                `The pressure is heavy.`,
                `You are not a script.`,
                `Building towards ${Config.dream}.`,
                `${Config.name} is finding the way.`
            ];
            this.storyDisplay.style.opacity = 0;
            setTimeout(() => {
                let idx = reset ? 0 : Math.min(Math.floor(Engine.score / 5), stories.length - 1);
                this.storyDisplay.innerText = stories[idx];
                this.storyDisplay.style.opacity = 1;
            }, 500);
        },

        showGameOver() {
            this.hud.style.display = 'none';
            this.generateShareCanvas();
            this.gameOverPanel.classList.add('active-panel');
        },

        generateShareCanvas() {
            const sCanvas = document.createElement('canvas');
            sCanvas.width = 1080; sCanvas.height = 1920;
            const sCtx = sCanvas.getContext('2d');

            let bgGrad = sCtx.createLinearGradient(0,0,0,sCanvas.height);
            bgGrad.addColorStop(0, "#0a0a1a"); bgGrad.addColorStop(1, "#1a1a2e");
            sCtx.fillStyle = bgGrad; sCtx.fillRect(0,0,sCanvas.width,sCanvas.height);

            sCtx.fillStyle = Config.color;
            sCtx.beginPath(); sCtx.arc(540, 500, 150, 0, Math.PI*2); sCtx.fill();
            sCtx.filter = 'blur(100px)'; sCtx.fill(); sCtx.filter = 'none';

            sCtx.textAlign = "center"; sCtx.fillStyle = "#ffffff";
            sCtx.font = "bold 250px 'Space Grotesk', sans-serif";
            sCtx.fillText(Engine.score, 540, 600);
            
            sCtx.font = "40px 'Space Grotesk', sans-serif";
            sCtx.fillStyle = "rgba(255,255,255,0.7)";
            
            // Format the text properly so it doesn't break if you added 10 words
            let pressureText = Config.pressures.length > 2 
                ? `${Config.pressures.length} Pressures` 
                : Config.pressures.join(" & ");

            sCtx.fillText(`Dodged ${pressureText}.`, 540, 900);
            sCtx.fillText(`Building towards ${Config.dream}.`, 540, 970);

            sCtx.font = "bold 50px 'Space Grotesk', sans-serif";
            sCtx.fillStyle = Config.color;
            sCtx.fillText(Config.name.toUpperCase(), 540, 1400);

            if(Config.isCreator && Config.handle) {
                sCtx.font = "40px 'Space Grotesk', sans-serif";
                sCtx.fillStyle = "#ffffff";
                sCtx.fillText(`Play at link in bio: ${Config.handle}`, 540, 1750);
            }

            document.getElementById('share-preview').src = sCanvas.toDataURL('image/png');
        }
    };

    UI.init();
</script>
</body>
</html>
